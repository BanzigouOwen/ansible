---
- name: Define command map for vendors
  set_fact:
    command_map:
      switch_cisco: "show running-config"
      switch_aruba: "display current-configuration"
      switch_huawei: "display current-configuration"

- name: Detect vendor for {{ target_switch }}
  set_fact:
    vendor: >-
      {%- if target_switch in (groups['switch_cisco'] | default([]) | list) -%}
      switch_cisco
      {%- elif target_switch in (groups['switch_aruba'] | default([]) | list) -%}
      switch_aruba
      {%- elif target_switch in (groups['switch_huawei'] | default([]) | list) -%}
      switch_huawei
      {%- else -%}
      unknown
      {%- endif -%}

- name: Debug vendor detection for {{ target_switch }}
  debug:
    msg: "Target switch: {{ target_switch }}, Vendor detected: {{ vendor }}, Cisco: {{ groups['switch_cisco'] | default([]) }}, Aruba: {{ groups['switch_aruba'] | default([]) }}, Huawei: {{ groups['switch_huawei'] | default([]) }}"

- name: Fail if vendor is unknown for {{ target_switch }}
  fail:
    msg: "Unknown switch vendor for {{ target_switch }}"
  when: vendor == "unknown"

- name: Set final command for {{ target_switch }}
  set_fact:
    final_command: "{{ command_map[vendor] }}"

- name: Telnet to target switch {{ target_switch }} to retrieve configuration
  expect:
    command: "telnet {{ target_switch }}"
    responses:
      "Username:": "{{ target_switch_username }}"
      "Password:": "{{ target_switch_password }}"
      ".*#": "{{ final_command }}\nexit"
    timeout: 30
    echo: yes
  register: running_config_result
  failed_when: "'Login incorrect' in running_config_result.stdout or 'not found' in running_config_result.stdout"
  ignore_errors: yes

- name: Skip this host if Telnet failed for {{ target_switch }}
  meta: end_host
  when: running_config_result is failed or not running_config_result.stdout

- name: Extract switch hostname from configuration for {{ target_switch }}
  set_fact:
    switch_hostname: >-
      {%- set search_result = running_config_result.stdout | regex_search('hostname\\s+(\\S+)', '\\1') -%}
      {%- if search_result is iterable and search_result | length > 0 -%}
      {{ search_result | first }}
      {%- else -%}
      {{ target_switch }}
      {%- endif -%}

- name: Set file path variable for configuration file for switch {{ target_switch }}
  set_fact:
    config_file_path: >-
      {{ base_dir }}/{{ current_date }}/{{ switch_hostname | replace('\n','') | replace('"','') | replace("'",'') }}_IP_{{ target_switch | replace('.', '-') }}_{{ current_date }}.txt

- name: Check if the configuration file already exists for switch {{ target_switch }}
  stat:
    path: "{{ config_file_path }}"
  register: file_check

- name: Save running configuration to file if it does not exist already for switch {{ target_switch }}
  copy:
    content: "{{ running_config_result.stdout }}"
    dest: "{{ config_file_path }}"
    mode: '0644'
  when: not file_check.stat.exists

- name: Display final message for switch {{ target_switch }}
  debug:
    msg: >
      {% if file_check.stat.exists %}
      The configuration file already exists at {{ config_file_path }}. No new file was created.
      {% else %}
      The running configuration has been successfully saved at {{ config_file_path }}.
      {% endif %}
